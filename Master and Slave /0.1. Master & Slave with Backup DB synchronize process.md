Alright! Letâ€™s break this down step-by-step:

---

## **Algorithm for DB Synchronization (Master â†’ Slave â†’ Backup DB)**

### Steps:

1. **Connect to Master, Slave, and Backup databases.**
2. **Fetch Data from Master DB Table.**

   * If Master DB has no data, fallback to Slave DB.
3. **Clear the corresponding table in Backup DB.**
4. **Insert the fetched data into Backup DB table.**
5. **For Dynamic Sync:**

   * Repeat steps 2-4 every X seconds.

---

## **ASCII Diagram (Master â†’ Slave â†’ Backup Sync)**

```
+-----------+             +-----------+             +------------+
|  Master   |  --------->  |  Backup   | <---------  |   Slave    |
|   DB      |    (Sync)    |   DB      |   (Fallback)|    DB      |
+-----------+             +-----------+             +------------+
      |                           â†‘
      |                           |
      +--- Dynamic Sync Loop -----+
              (Every X Seconds)
```

---

## **PHP Code with Comments**

```php
<?php

class DBSynchronizer
{
    private $master;
    private $slave;
    private $backup;

    public function __construct($masterConfig, $slaveConfig, $backupConfig)
    {
        // Step 1: Connect to Master, Slave, and Backup DB
        $this->master = $this->connect($masterConfig);
        $this->slave = $this->connect($slaveConfig);
        $this->backup = $this->connect($backupConfig);
    }

    private function connect($config)
    {
        // Create PDO connection
        return new PDO("mysql:host={$config['host']};dbname={$config['dbname']}", $config['user'], $config['pass']);
    }

    public function staticSync($table)
    {
        echo "Starting Static Sync...\n";

        // Step 2: Fetch data from Master DB table
        $data = $this->fetchTableData($this->master, $table);

        // If Master has no data, try Slave
        if (empty($data)) {
            $data = $this->fetchTableData($this->slave, $table);
        }

        // If data found, synchronize with Backup DB
        if (!empty($data)) {
            // Step 3: Clear Backup Table
            $this->clearTable($this->backup, $table);
            // Step 4: Insert Data into Backup Table
            $this->insertTableData($this->backup, $table, $data);
            echo "Static Sync Complete.\n";
        } else {
            echo "No data found in Master or Slave.\n";
        }
    }

    public function dynamicSync($table, $intervalSeconds = 10)
    {
        echo "Starting Dynamic Sync...\n";
        while (true) {
            // Repeat Static Sync every X seconds (Dynamic Sync Loop)
            $this->staticSync($table);
            sleep($intervalSeconds);
        }
    }

    private function fetchTableData($pdo, $table)
    {
        // Fetch all rows from given table
        $stmt = $pdo->prepare("SELECT * FROM {$table}");
        $stmt->execute();
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    private function clearTable($pdo, $table)
    {
        // Clear all rows in Backup table
        $pdo->exec("DELETE FROM {$table}");
    }

    private function insertTableData($pdo, $table, $data)
    {
        if (empty($data)) return;

        // Prepare Insert Statement
        $columns = array_keys($data[0]);
        $colStr = implode(",", $columns);
        $placeholders = implode(",", array_fill(0, count($columns), "?"));

        $stmt = $pdo->prepare("INSERT INTO {$table} ({$colStr}) VALUES ({$placeholders})");

        // Insert Each Row
        foreach ($data as $row) {
            $stmt->execute(array_values($row));
        }
    }
}

// Example Usage:
$masterDB = ['host' => '127.0.0.1', 'dbname' => 'master_db', 'user' => 'root', 'pass' => ''];
$slaveDB  = ['host' => '127.0.0.2', 'dbname' => 'slave_db', 'user' => 'root', 'pass' => ''];
$backupDB = ['host' => '127.0.0.3', 'dbname' => 'backup_db', 'user' => 'root', 'pass' => ''];

$synchronizer = new DBSynchronizer($masterDB, $slaveDB, $backupDB);

// Static Sync (One-time)
$synchronizer->staticSync('users');

// Dynamic Sync (Continuous Sync Every 10s)
// $synchronizer->dynamicSync('users', 10); // Uncomment for auto sync
?>
```

---

## ðŸ”‘ **Whatâ€™s Happening?**

| Step | Action                                            |
| ---- | ------------------------------------------------- |
| 1    | Establish DB connections (Master, Slave, Backup). |
| 2    | Fetch data from Master table.                     |
| 3    | If Master has no data, fallback to Slave.         |
| 4    | Clear the Backup DB's table.                      |
| 5    | Insert fetched data into Backup DB table.         |
| 6    | (Dynamic Mode) Repeat sync every X seconds.       |

---


